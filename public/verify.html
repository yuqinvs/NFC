<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Verification Result - NFC Verification System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <img src="logo.png" alt="NFC Verification System Logo" class="logo">
                <div class="header-text">
                    <h1>üîç Product Verification Result</h1>
                </div>
            </div>
        </header>

        <main>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Verifying product...</p>
            </div>

            <div id="verificationResult" class="verification-result" style="display: none;">
                <!-- Verification result will be displayed here -->
            </div>

            <div class="actions">
                <button onclick="window.location.href='/'">Back to Home</button>
                <button onclick="verifyAgain()">Verify Again</button>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 NFC Product Verification System</p>
        </footer>
    </div>

    <script>
        // Get NFC code from URL and auto-verify
        window.onload = async function() {
            const url = new URL(window.location.href);
            const nfcCode = url.searchParams.get('nfcid') || url.searchParams.get('nfc_code') || url.searchParams.get('nfc');
            if (!nfcCode) {
              showError('Áº∫Â∞ë NFC ÁºñÁ†ÅÔºåËØ∑‰ΩøÁî® ?nfcid=xxx Ê†ºÂºèÁöÑÈìæÊé•');
              return;
            }
            await verifyProductDirect(nfcCode);
        };

        async function verifyProductDirect(nfcCode) {
            try {
                const response = await fetch(`/api/verify?nfcid=${encodeURIComponent(nfcCode)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json().catch(() => null);
                
                document.getElementById('loading').style.display = 'none';
                
                if (response.ok && data) {
                    displayVerificationResult(data);
                } else {
                    const message = (data && (data.error || data.message)) || `Status ${response.status}`;
                    const details = data && data.details ? data.details : '';
                    displayError(message, details);
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                displayError('Network error, please try again later', error && error.message ? error.message : '');
            }
        }

        function displayVerificationResult(data) {
            const resultDiv = document.getElementById('result');
            const modalTitle = document.getElementById('modal-title');
            const modalDetails = document.getElementById('modal-details');

            resultDiv.classList.remove('loading');

            if (!data || typeof data.isAuthentic === 'undefined') {
              showError('Verification failed. Please try again.');
              return;
            }

            if (data.isAuthentic) {
              modalTitle.innerHTML = `‚úÖ Verified Authentic`;

              const scanCount = data.scanCount || 1;
              const countryName = data.countryName || 'Unknown';
              const countryRank = data.countryRank;

              const rankingHtml = (data.isNewUser && typeof countryRank !== 'undefined')
                ? `<div class="detail-item"><span class="label">Regional Ranking:</span><span class="value">#${countryRank} unique NFC</span></div>`
                : '';

              modalDetails.innerHTML = `
                <div class="detail-item"><span class="label">Product:</span><span class="value">${data.productName || 'NFC Product'}</span></div>
                <div class="detail-item"><span class="label">Scan Count:</span><span class="value">${scanCount}</span></div>
                <div class="detail-item"><span class="label">Scan Region:</span><span class="value">${countryName}</span></div>
                ${rankingHtml}
              `;
            } else {
              modalTitle.innerHTML = `‚ö†Ô∏è Potential Counterfeit`;
              modalDetails.innerHTML = `
                <div class="detail-item"><span class="label">Product:</span><span class="value">${data.productName || 'Unknown Product'}</span></div>
                <div class="detail-item"><span class="label">Scan Count:</span><span class="value">${data.scanCount || 1}</span></div>
                <div class="detail-item"><span class="label">Scan Region:</span><span class="value">${data.countryName || 'Unknown'}</span></div>
              `;
            }

            resultDiv.classList.add('success');
        }

        function displayError(message, details = '') {
            const resultDiv = document.getElementById('verificationResult');
            resultDiv.innerHTML = `
                <div class="error">
                    <h3>‚ùå Verification Failed</h3>
                    <p>${message}</p>
                    ${details ? `<pre style="white-space:pre-wrap;word-break:break-all;">${details}</pre>` : ''}
                </div>
            `;
            resultDiv.style.display = 'block';
        }

        function verifyAgain() {
            const nfcCode = prompt('Please enter NFC code:');
            if (nfcCode) {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('verificationResult').style.display = 'none';
                verifyProductDirect(nfcCode);
            }
        }
    </script>
</body>
</html>